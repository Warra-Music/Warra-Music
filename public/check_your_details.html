<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="Me" content="Jason Brogniez">
  <title>Check Your Details</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>
<div class="page">
  <div class="containerBackground">
    <div class="titleBar">
      <p><img src="finalLogo_pic.png" alt="Logo" title="Warra Music" height="105" width="95" loading="eager"></p>
    </div>
    <div class="menu-wrapper">
      <button class="menu-button"><div class="menu-icon"></div></button>
      <nav>
        <ul>
          <li><a href="index.html#titleBar">Private Lessons</a></li>
          <li><a href="index.html#Online">Online Lessons</a></li>
          <li><a href="index.html#Contacts">Contacts</a></li>
          <li><a href="index.html#description">About</a></li>
        </ul>
      </nav>
    </div>
  </div>

  <div class="details">
    <h1>Check your details!</h1>
  </div>

  <div class="nav-buttons">
    <button id="checkout-30" class="next"><p>30 min lessons !</p></button>
    <button id="checkout-60" class="back"><p>60 min lessons !</p></button>
  </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const dateParam = urlParams.get('date');
const timeParam = urlParams.get('time');
if (dateParam) localStorage.setItem('bookingDate', dateParam);
if (timeParam) localStorage.setItem('time', timeParam);

// Grab saved values
const instrument = localStorage.getItem('instrument') || 'Not selected';
const level = localStorage.getItem('level') || 'Not selected';
const name = localStorage.getItem('name') || 'Not provided';
const email = localStorage.getItem('email') || 'Not provided';
const number = localStorage.getItem('number') || 'Not provided';
const birthDate = localStorage.getItem('birthDate') || 'Not selected';
const bookingDate = localStorage.getItem('bookingDate') || 'Not provided';
const time = localStorage.getItem('time') || 'Not selected';
const weekday = localStorage.getItem('weekday') || 'Not selected';
const method = (localStorage.getItem('method') || 'Private').trim(); // Safe default

function renderDetails(plan) {
  let price = 0;
  if (method === "Private") price = plan === "60min" ? 80 : 40;
  else if (method === "Zoom") price = plan === "60min" ? 60 : 30;

  let duration = plan === "60min" ? "60 Minutes Music Lessons" : "30 Minutes Music Lessons";

  document.querySelector('.details').innerHTML = `
    <h1>Check your details!</h1>
    <div class="detailBlocks">
      <h2>Your Details</h2>
      <p>Your Name: ${name}</p>
      <p>Your Phone Number: ${number}</p>
      <p>Your Email Address: ${email}</p>
    </div>
    <div class="detailBlocks">
      <h2>Booking Details</h2>
      <p>Instrument: ${instrument}</p>
      <p>Booking: ${duration}</p>
      <p>Weekday: ${weekday}</p>
      <p>Time: ${time}</p>
      <p>Start Date: ${bookingDate}</p>
    </div>
    <div class="detailBlocks">
      <h2>Where</h2>
      <p>${method}</p>
    </div>
    <div class="detailBlocks">
      <h2>Payment Information</h2>
      <p>A weekly fee of $${price} will be charged</p>
      <p>starting the day before your first lesson.</p>
      <p>You can cancel your subscription at any time</p>
    </div>
    <div class="detailBlocks">
      <p>By clicking pay now below, you accept and agree to the</p>
      <p>terms and conditions for music lessons Warra Music.</p>
    </div>
  `;
}

document.addEventListener('DOMContentLoaded', () => {
  const stripe = Stripe('pk_test_51RhNOHBbgLT6ovycOTKajCBx4mf2J19nekj1nqFdLIGPtveJnr044z2oYbGuevdjqXZ0dOAyWUEXfjkFaePzH3ne00dwF71M7j');

  function handleCheckout(plan) {
    renderDetails(plan);

    fetch('https://warramusic.onrender.com/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        instrument, level, name, email, number,
        bookingDate, time, weekday, method, plan
      })
    })
    .then(res => res.json())
    .then(session => {
      if (!session.id) {
        alert("⚠️ Stripe session not created. Check your backend logs.");
        console.log("Backend returned:", session);
        return;
      }
      return stripe.redirectToCheckout({ sessionId: session.id });
    })
    .then(result => {
      if (result && result.error) alert(result.error.message);
    })
    .catch(err => {
      console.error("❌ Error creating checkout session:", err);
      alert("Failed to start checkout. Check console for details.");
    });
  }

  document.getElementById('checkout-30').addEventListener('click', () => handleCheckout("30min"));
  document.getElementById('checkout-60').addEventListener('click', () => handleCheckout("60min"));

  renderDetails("30min");
});
</script>
</body>
</html>
