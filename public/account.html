<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Account - Warra Music</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>My Account</h1>
    <p>Manage your subscription below.</p>

    <button id="manage-button" class="manage-button">Manage Subscription</button>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const customerId = localStorage.getItem('customer_id');
      const portalButton = document.getElementById('manage-button');

      if (!customerId) {
        portalButton.disabled = true;
        portalButton.textContent = "Unavailable";
        return;
      }

      portalButton.addEventListener('click', async () => {
        portalButton.disabled = true;
        portalButton.textContent = "Loading...";

        try {
          const resp = await fetch('https://warra-music.onrender.com/customer-portal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customer_id: customerId })
          });

          const data = await resp.json();

          if (data.url) {
            window.location.href = data.url;
          } else {
            alert("Unable to open Manage Account portal.");
            console.error(data);
            portalButton.disabled = false;
            portalButton.textContent = "Manage Subscription";
          }
        } catch (err) {
          console.error(err);
          alert("Failed to open Manage Account portal.");
          portalButton.disabled = false;
          portalButton.textContent = "Manage Subscription";
        }
      });
    });
  </script>
</body>
</html>
